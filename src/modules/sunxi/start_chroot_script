#!/usr/bin/env bash
#### yumios module
####
#### This is a modified version for Yumi-Lab
#### Modifikation done by Stephan Wendel aka KwadFan <me@stephanwe.de>
####
#### Written by Stephan Wendel aka KwadFan <me@stephanwe.de>
#### Copyright 2021 - 2022
#### https://github.com/mainsail-crew/MainsailOS
####
#### This File is distributed under GPLv3
####

# shellcheck enable=require-variable-braces
# Source error handling, leave this in place
set -Ee

# Source CustomPIOS common.sh
# shellcheck disable=SC1091
source /common.sh

echo "Fix sunxi ..."

    # ğŸ“‚ RÃ©pertoire pour stocker les fichiers kernel
    mkdir -p /opt/kernel_deb

    # ğŸ“¥ URLs GitHub avec les fichiers en raw
    GITHUB_REPO="https://raw.githubusercontent.com/Yumi-Lab/SmartPi-armbian/develop/userpatches/header"

    echo "ğŸ“¥ TÃ©lÃ©chargement des fichiers kernel depuis GitHub..."

    curl -L -o /opt/kernel_deb/linux-image-current-sunxi.deb "$GITHUB_REPO/linux-image-current-sunxi_24.2.1_armhf.deb"
    curl -L -o /opt/kernel_deb/linux-headers-current-sunxi.deb "$GITHUB_REPO/linux-headers-current-sunxi_24.2.1_armhf.deb"

    # VÃ©rification des fichiers
    if [[ ! -f /opt/kernel_deb/linux-image-current-sunxi.deb || ! -f /opt/kernel_deb/linux-headers-current-sunxi.deb ]]; then
        echo "âŒ Erreur : Impossible de tÃ©lÃ©charger les fichiers kernel depuis GitHub."
        exit 1
    fi

    echo "âœ… Fichiers kernel tÃ©lÃ©chargÃ©s avec succÃ¨s !"

    # ğŸ“œ Script oneshot pour le premier dÃ©marrage
    echo "CrÃ©er le script oneshot pour le premier dÃ©marrage"
    cat << 'EOF' > /opt/kernel_deb/install_kernel.sh
#!/bin/bash
echo "ğŸ”§ Installation du kernel custom..."

# VÃ©rification des fichiers
if [[ ! -f /opt/kernel_deb/linux-image-current-sunxi.deb || ! -f /opt/kernel_deb/linux-headers-current-sunxi.deb ]]; then
    echo "âŒ Fichiers kernel introuvables. Annulation."
    exit 1
fi

# Installation des paquets
echo "âš™ï¸ Installation du kernel..."
sudo dpkg -i /opt/kernel_deb/*.deb

# VÃ©rification de l'installation
if [[ $? -ne 0 ]]; then
    echo "âŒ Erreur lors de l'installation des paquets. Abandon."
    exit 1
fi

# ğŸ›‘ DÃ©sactivation du service aprÃ¨s installation
echo "ğŸ›‘ DÃ©sactivation du service kernel-setup.service..."
sudo systemctl disable kernel-setup.service
sudo rm -f /etc/systemd/system/kernel-setup.service

# ğŸš€ Activer armbian-firstboot pour la configuration initiale
#echo "ğŸ›  RÃ©activation de armbian-firstboot pour la configuration initiale..."
#sudo touch /root/.not_logged_in_yet
#sudo systemctl enable armbian-firstboot.service

# CrÃ©ation d'un fichier de contrÃ´le
touch /opt/kernel_installed

# ğŸ”„ RedÃ©marrage du systÃ¨me
echo "ğŸ”„ RedÃ©marrage du systÃ¨me..."
sudo reboot
EOF

    chmod +x /opt/kernel_deb/install_kernel.sh

    # ğŸ–¥ï¸ Service systemd pour installer le kernel au premier boot
    echo "Ajouter le service systemd pour installer le kernel au premier boot"
    cat << 'EOF' > /etc/systemd/system/kernel-setup.service
[Unit]
Description=Installation du kernel custom au premier dÃ©marrage
Wants=network.target
After=network.target

[Service]
Type=oneshot
ExecStart=/opt/kernel_deb/install_kernel.sh
ExecStop=/bin/true
RemainAfterExit=no

[Install]
WantedBy=multi-user.target
EOF

systemctl enable kernel-setup.service
echo "Fix sunxi ... [DONE]"
