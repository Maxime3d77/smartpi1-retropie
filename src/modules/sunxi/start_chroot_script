#!/usr/bin/env bash
#### yumios module
####
#### This is a modified version for Yumi-Lab
#### Modifikation done by Stephan Wendel aka KwadFan <me@stephanwe.de>
####
#### Written by Stephan Wendel aka KwadFan <me@stephanwe.de>
#### Copyright 2021 - 2022
#### https://github.com/mainsail-crew/MainsailOS
####
#### This File is distributed under GPLv3
####

# shellcheck enable=require-variable-braces
## Source error handling, leave this in place
set -Ee

#!/bin/bash

# Définir la version souhaitée du kernel
TARGET_KERNEL="6.6.16-current-sunxi"

# Récupérer la version actuelle du kernel
CURRENT_KERNEL=$(uname -r)

echo "Vérification de la version actuelle du kernel..."
echo "Kernel actuel : $CURRENT_KERNEL"
echo "Kernel souhaité : $TARGET_KERNEL"

if [ "$CURRENT_KERNEL" != "$TARGET_KERNEL" ]; then
    echo "Le kernel actuel ne correspond pas. Correction en cours..."
    
    # Supprimer les headers et le kernel actuels s'ils sont incorrects
    sudo apt remove --purge -y linux-image-current-sunxi linux-headers-current-sunxi linux-libc-dev
    
    # Réinstaller la bonne version
    sudo apt install -y linux-image-current-sunxi=24.2.1 linux-headers-current-sunxi=24.2.1
    
    # Mettre à jour GRUB
    echo "Mise à jour de GRUB..."
    sudo update-grub
    
    echo "Redémarrage du système..."
    sudo reboot
else
    echo "Le kernel est déjà correct. Blocage des mises à jour..."
    
    # Bloquer la mise à jour du kernel et des headers
    sudo apt-mark hold linux-image-current-sunxi linux-headers-current-sunxi linux-libc-dev
    
    # Empêcher les mises à jour avec un fichier de préférences
    echo "Création du fichier de préférences APT..."
    sudo bash -c 'cat <<EOF > /etc/apt/preferences.d/no-kernel-upgrade
Package: linux-image-*
Pin: release *
Pin-Priority: -1

Package: linux-headers-*
Pin: release *
Pin-Priority: -1

Package: linux-libc-dev
Pin: release *
Pin-Priority: -1
EOF'

    echo "Le kernel est maintenant verrouillé et ne sera plus mis à jour."
fi
